<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Virtual Desk Assistant - Hiyori</title>

   <!-- ë°°ê²½ ì™„ì „ íˆ¬ëª… + ìºë¦­í„°ë§Œ í´ë¦­ ê°€ëŠ¥ -->
   <style>
     html, body {
       margin: 0;
       height: 100%;
       overflow: hidden;
       background: transparent;
       /* ë°°ê²½ì€ í´ë¦­-ìŠ¤ë£¨ */
       pointer-events: none;
     }
     #app {
       width: 100%;
       height: 100%;
       position: relative;
       pointer-events: none;
     }
     #stage {
       position: fixed;
       inset: 0;
       pointer-events: none;
     }
     /* canvasë§Œ í´ë¦­ ê°€ëŠ¥ (Live2D ìºë¦­í„°) */
     canvas {
       pointer-events: auto !important;
       cursor: move; /* ë“œë˜ê·¸ ê°€ëŠ¥ í‘œì‹œ */
     }
   </style>
</head>

<body>
  <div id="app">
    <div id="stage"></div>
  </div>

  <script>
    /****************************************************************
     * Electron ipcRenderer ì¤€ë¹„
     * - ë¸Œë¼ìš°ì €ë¡œ ì—´ì—ˆì„ ë•ŒëŠ” requireê°€ ì—†ìœ¼ë‹ˆ try/catch
     ****************************************************************/
    let ipcRenderer = null;
    try {
      // electron í™˜ê²½
      ipcRenderer = require('electron').ipcRenderer;
    } catch (e) {
      console.warn('Electron í™˜ê²½ì´ ì•„ë‹ˆì–´ì„œ ipcRenderer ì—†ìŒ:', e);
    }

    /****************************************************************
     * ìˆœì°¨ ë¡œë”
     * - ì˜ì¡´ì„± â†’ ì½”ì–´ â†’ í”ŒëŸ¬ê·¸ì¸ ìˆœì„œ ë³´ì¥
     * - CDN ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ í›„ë³´ ìë™ ì‹œë„
     ****************************************************************/
    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = url;
        s.async = false;               // ë¡œë“œ ìˆœì„œ ë³´ì¥(ì¤‘ìš”)
        s.onload = () => { console.log('âœ… ë¡œë“œ ì„±ê³µ:', url); resolve(); };
        s.onerror = () => { console.error('âŒ ë¡œë“œ ì‹¤íŒ¨:', url); reject(new Error(url)); };
        document.head.appendChild(s);
      });
    }

    // ì „ì—­ì—ì„œ ì“¸ ì°¸ì¡°ìš© (ìŠ¤ì¼€ì¼ ì¡°ì ˆì„ ìœ„í•´)
    let app = null;
    let model = null;

    async function init() {
      try {
        /******** 1) Pixi.js (v6.x) : í”ŒëŸ¬ê·¸ì¸ 0.4.xì™€ í˜¸í™˜ ********/
        const pixiCdn = [
          'https://cdn.jsdelivr.net/npm/pixi.js@6.5.10/dist/browser/pixi.min.js',
          'https://unpkg.com/pixi.js@6.5.10/dist/browser/pixi.min.js'
        ];
        let ok = false;
        for (const url of pixiCdn) {
          try { await loadScript(url); ok = true; break; } catch {}
        }
        if (!ok) throw new Error('Pixi.js ë¡œë“œ ì‹¤íŒ¨');
        console.log('PIXI.VERSION =', window.PIXI && PIXI.VERSION);

        /******** 2) Live2D Cubism Core : í”ŒëŸ¬ê·¸ì¸ì´ ì°¸ì¡°í•˜ëŠ” ëŸ°íƒ€ì„ ********/
        const coreCdn = [
          'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js',
          'https://cubism.live2d.com/sdk-web/bin/live2dcubismcore.min.js'
        ];
        ok = false;
        for (const url of coreCdn) {
          try { await loadScript(url); ok = true; break; } catch {}
        }
        if (!ok) throw new Error('Live2D Cubism Core ë¡œë“œ ì‹¤íŒ¨');
        console.log('Live2DCubismCore =', typeof window.Live2DCubismCore); // "object" ê¸°ëŒ€

        /******** 3) pixi-live2d-display (Cubism4 ë¹Œë“œ, 0.4.x) ********/
        const pluginCdn = [
          'https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.js',
          'https://unpkg.com/pixi-live2d-display@0.4.0/dist/cubism4.js',
          'https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display@v0.4.0/dist/cubism4.js'
        ];
        ok = false;
        for (const url of pluginCdn) {
          try {
            await loadScript(url);
            if (window.PIXI?.live2d?.Live2DModel) { ok = true; break; }
          } catch {}
        }
        if (!ok) throw new Error('pixi-live2d-display (cubism4) ë¡œë“œ ì‹¤íŒ¨');

        console.log('PIXI.live2d keys:', Object.keys(PIXI.live2d || {}));

        /******** 4) Pixi ì•± & Live2D ëª¨ë¸ ë¡œë“œ ********/
        app = new PIXI.Application({ backgroundAlpha: 0, resizeTo: window });
        document.getElementById('stage').appendChild(app.view);

        const MODEL_URL = 'public/models/hiyori_free_ko/runtime/hiyori_free_t08.model3.json';
        console.log('ğŸ“¦ ëª¨ë¸ ë¡œë”©:', MODEL_URL);

        model = await PIXI.live2d.Live2DModel.from(MODEL_URL);

         // ë°°ì¹˜: í™”ë©´ ìš°ì¸¡ í•˜ë‹¨
         model.anchor.set(0.5, 1);
         model.scale.set(0.2); // ì´ˆê¸° í¬ê¸° 20% ì¤„ì„ (0.25 â†’ 0.2)
         model.position.set(window.innerWidth - 150, window.innerHeight - 50);
         app.stage.addChild(model);

         // ìƒí˜¸ì‘ìš©: íƒ­ ëª¨ì…˜ (ë“œë˜ê·¸ê°€ ì•„ë‹ ë•Œë§Œ)
         model.interactive = true;
         let clickStartPos = null;
         model.on('pointerdown', (e) => {
           clickStartPos = { x: e.data.global.x, y: e.data.global.y };
         });
         model.on('pointerup', (e) => {
           if (!clickStartPos) return;
           const dx = Math.abs(e.data.global.x - clickStartPos.x);
           const dy = Math.abs(e.data.global.y - clickStartPos.y);
           // ì´ë™ ê±°ë¦¬ê°€ 5px ì´í•˜ë©´ í´ë¦­ìœ¼ë¡œ ê°„ì£¼
           if (dx < 5 && dy < 5) {
             console.log('ğŸ‘† ìºë¦­í„° í´ë¦­!');
             model.motion?.('Tap');
           }
           clickStartPos = null;
         });

        console.log('ğŸ‰ ì¤€ë¹„ ì™„ë£Œ!');

        // ëª¨ë¸ ì¤€ë¹„ëœ í›„ ì¸í„°ë™ì…˜ ì œì–´ ë¡œì§ ì„¸íŒ…
        setupInteractionControls();

      } catch (err) {
        console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
        document.getElementById('app').innerHTML =
          `<div style="color:white;padding:20px;font-family:monospace;">
            <h2>âŒ ë¡œë“œ ì‹¤íŒ¨</h2>
            <p>${err.message}</p>
            <p>DevTools â†’ Network/Console í™•ì¸</p>
          </div>`;
      }
    }

    /****************************************************************
     * ì¸í„°ë™ì…˜ ì œì–´
     * - ìºë¦­í„° ë“œë˜ê·¸: ìºë¦­í„° ìœ„ì¹˜ ì´ë™
     * - +/- í‚¤: í¬ê¸° ì¡°ì ˆ
     * - ìºë¦­í„° ë°”ìš´ë”© ë°•ìŠ¤ë§Œ í´ë¦­ ê°€ëŠ¥ (ë™ì  ì¡°ì ˆ)
     ****************************************************************/
    function setupInteractionControls() {
      let isDragging = false;
      let lastClientX = 0;
      let lastClientY = 0;

      // í¬ê¸° ì¡°ì ˆ í•¨ìˆ˜
      const adjustScale = (delta) => {
        if (!model) return;
        const step = 0.05;
        let newScale = model.scale.x + delta * step;
        newScale = Math.max(0.1, Math.min(1.0, newScale));
        model.scale.set(newScale);
        console.log('ğŸ” í¬ê¸°:', newScale.toFixed(2));
      };

      // í‚¤ë³´ë“œë¡œ í¬ê¸° ì¡°ì ˆ ë° ì¢…ë£Œ: +/- í‚¤, ESC í‚¤
      window.addEventListener('keydown', (e) => {
        if (e.key === '+' || e.key === '=') {
          e.preventDefault();
          adjustScale(1);
        } else if (e.key === '-' || e.key === '_') {
          e.preventDefault();
          adjustScale(-1);
        } else if (e.key === 'Escape') {
          e.preventDefault();
          console.log('âŒ¨ï¸  ESC í‚¤ - ì•± ì¢…ë£Œ');
          if (ipcRenderer) {
            ipcRenderer.send('va:request-quit');
          }
        }
      });

      // ìºë¦­í„° ë“œë˜ê·¸ë¡œ ìœ„ì¹˜ ì´ë™
      document.addEventListener('mousedown', (e) => {
        if (e.target.tagName !== 'CANVAS') return;
        isDragging = true;
        lastClientX = e.clientX;
        lastClientY = e.clientY;
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (isDragging && model) {
          const dx = e.clientX - lastClientX;
          const dy = e.clientY - lastClientY;
          lastClientX = e.clientX;
          lastClientY = e.clientY;
          
          // ìºë¦­í„° ìœ„ì¹˜ ì´ë™
          model.position.x += dx;
          model.position.y += dy;
        }
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
      });

      // ìºë¦­í„°ì˜ ì‹¤ì œ ë°”ìš´ë”© ë°•ìŠ¤ë§Œ í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ë™ì  ì²´í¬
      if (ipcRenderer && model) {
        let isOverCharacter = false;
        
        const checkIfOverCharacter = (clientX, clientY) => {
          if (!model) return false;
          
          // ìºë¦­í„°ì˜ ì‹¤ì œ ë°”ìš´ë”© ë°•ìŠ¤ ê°€ì ¸ì˜¤ê¸°
          const bounds = model.getBounds();
          
          // Live2D ë°”ìš´ë”© ë°•ìŠ¤ê°€ ì‹¤ì œë³´ë‹¤ ë„“ìœ¼ë¯€ë¡œ ì¢Œìš°ë¥¼ ëŒ€í­ ì¶•ì†Œ
          const actualWidth = bounds.width * 0.4;  // ì‹¤ì œ ë„ˆë¹„ì˜ 40%ë§Œ ì‚¬ìš© (50%ì—ì„œ 20% ì¶”ê°€ ê°ì†Œ)
          const widthOffset = (bounds.width - actualWidth) / 2;  // ì¤‘ì•™ ì •ë ¬
          
          // ì„¸ë¡œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
          const verticalMargin = bounds.height * 0.05;
          
          return clientX >= bounds.x + widthOffset && 
                 clientX <= bounds.x + widthOffset + actualWidth &&
                 clientY >= bounds.y - verticalMargin && 
                 clientY <= bounds.y + bounds.height + verticalMargin;
        };
        
        document.addEventListener('mousemove', (e) => {
          const wasOver = isOverCharacter;
          isOverCharacter = checkIfOverCharacter(e.clientX, e.clientY);
          
          // ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ IPC ì „ì†¡ (ì„±ëŠ¥ ìµœì í™”)
          if (wasOver !== isOverCharacter) {
            ipcRenderer.send('va:set-ignore-mouse', !isOverCharacter);
            // console.log('í´ë¦­ ê°€ëŠ¥:', isOverCharacter); // ë””ë²„ê¹…ìš©
          }
        });
      }
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
